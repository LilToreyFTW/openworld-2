<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haveila — Evil City Map</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #0a0508; font-family: 'Segoe UI', system-ui, sans-serif; }
    body { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #container {
      width: 100%;
      max-width: 2560px;
      height: 100%;
      max-height: 1080px;
      position: relative;
      border: 2px solid rgba(80,20,60,0.6);
      box-shadow: inset 0 0 80px rgba(40,0,30,0.3), 0 0 60px rgba(60,0,50,0.2);
    }
    #lava-world {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }
    #ui {
      position: absolute;
      top: 12px;
      left: 12px;
      right: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      pointer-events: none;
    }
    #ui > * { pointer-events: auto; }
    #title {
      background: rgba(0,0,0,0.85);
      color: #c070a0;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      border: 1px solid rgba(120,40,80,0.6);
    }
    #sound {
      background: rgba(0,0,0,0.85);
      color: #b080a0;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 12px;
      border: 1px solid rgba(120,40,80,0.6);
      cursor: pointer;
    }
    #sound:hover { background: rgba(30,10,25,0.95); }
    #beat-bar {
      position: absolute;
      bottom: 12px;
      left: 12px;
      right: 12px;
      height: 4px;
      background: rgba(0,0,0,0.7);
      border-radius: 2px;
      overflow: hidden;
    }
    #beat-fill {
      height: 100%;
      background: linear-gradient(90deg, #4a1030, #8b2060);
      width: 0%;
      transition: width 0.05s ease-out;
    }
  </style>
</head>
<body>
  <div id="container">
    <canvas id="lava-world" width="2560" height="1080"></canvas>
    <div id="ui">
      <div id="title">Haveila — Evil City Map</div>
      <button id="sound">▶ Play main soundtrack</button>
    </div>
    <div id="beat-bar"><div id="beat-fill"></div></div>
  </div>
  <audio id="main-soundtrack" loop>
    <source src="game-soundtrack/Haveila(dreadnaught spacemap animated).mp3" type="audio/mpeg">
  </audio>

  <script>
    const SOUNDTRACK_PATH = 'game-soundtrack/Haveila(dreadnaught spacemap animated).mp3';
    const W = 2560;
    const H = 1080;

    const canvas = document.getElementById('lava-world');
    const ctx = canvas.getContext('2d');
    const audio = document.getElementById('main-soundtrack');
    const beatFill = document.getElementById('beat-fill');
    const soundBtn = document.getElementById('sound');

    let audioCtx = null;
    let analyser = null;
    let dataArray = null;
    let beat = 0;
    let smoothBeat = 0;
    let time = 0;

    // —— Evil city map layout ——
    const GRID_COLS = 32;
    const GRID_ROWS = 14;
    const STREET = 14;
    const CELL_W = Math.floor((W - (GRID_COLS + 1) * STREET) / GRID_COLS);
    const CELL_H = Math.floor((H - (GRID_ROWS + 1) * STREET) / GRID_ROWS);
    const START_X = STREET;
    const START_Y = STREET;
    const EVIL_COLORS = [
      '#0d0a0f', '#1a1220', '#151018', '#0f0c14', '#1e1528', '#120d18', '#2a1a30', '#180f20'
    ];
    const EVIL_ACCENT = ['#3d1020', '#2d0a25', '#4a1535', '#5c0a30'];
    const EVIL_WINDOW = ['#2a1520', '#1a0a12', '#3d2030'];
    let cityBlocks = null;

    function seededRandom(seed) {
      return ((seed * 9301 + 49297) % 233280) / 233280;
    }

    function buildEvilCity() {
      const blocks = [];
      for (let row = 0; row < GRID_ROWS; row++) {
        for (let col = 0; col < GRID_COLS; col++) {
          const id = row * GRID_COLS + col;
          const cx = START_X + col * (CELL_W + STREET) + CELL_W / 2;
          const cy = START_Y + row * (CELL_H + STREET) + CELL_H / 2;
          const distToCenter = Math.hypot(cx - W / 2, cy - H / 2);
          const norm = Math.min(1, distToCenter / (W * 0.5));
          const isCitadel = norm < 0.2 && (col >= 14 && col <= 18);
          const isSlum = norm > 0.7;
          const isIndustrial = row >= GRID_ROWS - 3;
          let heightMult = 0.4 + seededRandom(id) * 0.7;
          if (isCitadel) heightMult = 0.9 + seededRandom(id * 7) * 0.4;
          if (isSlum) heightMult *= 0.5;
          if (isIndustrial) heightMult = 0.5 + seededRandom(id * 3) * 0.3;
          const colorIndex = Math.floor(seededRandom(id * 11) * EVIL_COLORS.length) % EVIL_COLORS.length;
          const accentIndex = Math.floor(seededRandom(id * 13) * EVIL_ACCENT.length) % EVIL_ACCENT.length;
          const windows = [];
          const numWindows = Math.floor(2 + seededRandom(id * 17) * 6);
          for (let w = 0; w < numWindows; w++) {
            if (seededRandom(id * 19 + w) > 0.4) continue;
            windows.push({
              x: (seededRandom(id * 23 + w) - 0.5) * CELL_W * 0.7,
              y: (seededRandom(id * 29 + w) - 0.5) * CELL_H * 0.6,
              lit: seededRandom(id * 31 + w) > 0.6
            });
          }
          blocks.push({
            col, row, id,
            x: START_X + col * (CELL_W + STREET),
            y: START_Y + row * (CELL_H + STREET),
            w: CELL_W, h: CELL_H,
            cx, cy,
            color: EVIL_COLORS[colorIndex],
            accent: EVIL_ACCENT[accentIndex],
            heightMult,
            isCitadel, isSlum, isIndustrial,
            windows,
            smokestack: isIndustrial && seededRandom(id * 41) > 0.6
          });
        }
      }
      return blocks;
    }

    function initAudio() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaElementSource(audio);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      analyser.smoothingTimeConstant = 0.8;
      source.connect(analyser);
      analyser.connect(audioCtx.destination);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
    }

    function getBeat() {
      if (!analyser || !dataArray) return 0;
      analyser.getByteFrequencyData(dataArray);
      let sum = 0;
      for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
      return sum / dataArray.length / 255;
    }

    function drawEvilSky() {
      const t = time * 0.001;
      const b = smoothBeat;
      const g = ctx.createLinearGradient(0, 0, 0, H);
      g.addColorStop(0, '#050208');
      g.addColorStop(0.3, '#0f0612');
      g.addColorStop(0.5, '#150a18');
      g.addColorStop(0.7, '#0d0610');
      g.addColorStop(1, '#1a0a20');
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, W, H);
      const moonGlow = ctx.createRadialGradient(W * 0.85, H * 0.15, 0, W * 0.85, H * 0.15, 400);
      moonGlow.addColorStop(0, 'rgba(60,30,70,' + (0.15 + b * 0.05) + ')');
      moonGlow.addColorStop(1, 'rgba(20,10,30,0)');
      ctx.fillStyle = moonGlow;
      ctx.fillRect(0, 0, W, H);
    }

    function drawEvilGround() {
      ctx.fillStyle = '#0a060c';
      ctx.fillRect(0, 0, W, H);
      for (let row = 0; row <= GRID_ROWS; row++) {
        for (let col = 0; col <= GRID_COLS; col++) {
          const x = START_X + col * (CELL_W + STREET);
          const y = START_Y + row * (CELL_H + STREET);
          ctx.fillStyle = '#080508';
          ctx.fillRect(x - STREET / 2, y - STREET / 2, STREET, STREET);
        }
      }
      ctx.fillStyle = '#0d080a';
      for (let row = 0; row < GRID_ROWS; row++) {
        for (let col = 0; col < GRID_COLS; col++) {
          const x = START_X + col * (CELL_W + STREET);
          const y = START_Y + row * (CELL_H + STREET);
          ctx.fillRect(x, y, CELL_W, CELL_H);
        }
      }
    }

    function drawEvilBuildings() {
      if (!cityBlocks) cityBlocks = buildEvilCity();
      const t = time * 0.001;
      const b = smoothBeat;
      const pulse = 0.7 + b * 0.3;
      for (const block of cityBlocks) {
        const { x, y, w, h, cx, cy, color, accent, heightMult, windows, smokestack, isCitadel } = block;
        const buildH = Math.max(20, h * heightMult);
        const topY = cy + h / 2 - buildH;
        const left = cx - w / 2;
        const right = cx + w / 2;
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(left, cy + h / 2);
        ctx.lineTo(left, topY);
        ctx.lineTo(right, topY);
        ctx.lineTo(right, cy + h / 2);
        ctx.closePath();
        ctx.fill();
        ctx.strokeStyle = accent;
        ctx.lineWidth = 1;
        ctx.stroke();
        if (isCitadel) {
          ctx.fillStyle = 'rgba(80,20,50,0.4)';
          ctx.fillRect(left + 2, topY + 2, w - 4, Math.min(40, buildH - 4));
        }
        windows.forEach(win => {
          const wx = cx + win.x;
          const wy = cy - h / 2 + (win.y + h / 2) * 0.5 + buildH * 0.15;
          const lit = win.lit && (pulse > 0.85 || (t * 2 + block.id) % 4 < 2);
          ctx.fillStyle = lit ? 'rgba(180,60,80,0.9)' : EVIL_WINDOW[block.id % 3];
          ctx.fillRect(wx - 3, wy - 4, 6, 8);
        });
        if (smokestack) {
          const sx = cx + (seededRandom(block.id * 43) - 0.5) * w * 0.3;
          ctx.fillStyle = '#0a0808';
          ctx.fillRect(sx - 8, topY - 50, 16, 50);
          const smoke = ctx.createRadialGradient(sx, topY - 55, 0, sx, topY - 80, 40);
          smoke.addColorStop(0, 'rgba(40,35,45,' + (0.3 + b * 0.1) + ')');
          smoke.addColorStop(1, 'rgba(20,18,25,0)');
          ctx.fillStyle = smoke;
          ctx.fillRect(sx - 45, topY - 120, 90, 70);
        }
      }
    }

    function drawEvilCitadel() {
      const cx = W / 2;
      const cy = H * 0.5;
      const towerW = 120;
      const towerH = 380;
      const topY = cy + 200 - towerH;
      const t = time * 0.001;
      const b = smoothBeat;
      ctx.fillStyle = '#0a0508';
      ctx.fillRect(cx - towerW / 2, topY, towerW, towerH);
      ctx.strokeStyle = '#2d0a20';
      ctx.lineWidth = 2;
      ctx.strokeRect(cx - towerW / 2, topY, towerW, towerH);
      const eyeY = topY + 80;
      const eyeGlow = ctx.createRadialGradient(cx, eyeY, 0, cx, eyeY, 60);
      eyeGlow.addColorStop(0, 'rgba(200,40,60,' + (0.4 + b * 0.2) + ')');
      eyeGlow.addColorStop(0.5, 'rgba(120,20,40,0.2)');
      eyeGlow.addColorStop(1, 'rgba(60,10,25,0)');
      ctx.fillStyle = eyeGlow;
      ctx.fillRect(cx - 70, topY + 20, 140, 120);
      ctx.fillStyle = 'rgba(220,50,70,0.95)';
      ctx.beginPath();
      ctx.ellipse(cx, eyeY, 18, 25, 0, 0, Math.PI * 2);
      ctx.fill();
    }

    function drawEvilFog() {
      const t = time * 0.001;
      const b = smoothBeat;
      const g = ctx.createLinearGradient(0, H * 0.5, 0, H);
      g.addColorStop(0, 'rgba(15,8,18,0)');
      g.addColorStop(0.4, 'rgba(25,12,30,' + (0.25 + b * 0.08) + ')');
      g.addColorStop(1, 'rgba(20,10,25,0.5)');
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, W, H);
      const drift = (t * 30) % (W + 200) - 100;
      const fogPatch = ctx.createRadialGradient(drift, H * 0.7, 0, drift, H * 0.7, 350);
      fogPatch.addColorStop(0, 'rgba(40,25,50,0.12)');
      fogPatch.addColorStop(1, 'rgba(30,18,40,0)');
      ctx.fillStyle = fogPatch;
      ctx.fillRect(0, 0, W, H);
    }

    function drawEvilVignette() {
      const g = ctx.createRadialGradient(W / 2, H / 2, H * 0.3, W / 2, H / 2, W * 0.6);
      g.addColorStop(0, 'rgba(0,0,0,0)');
      g.addColorStop(0.7, 'rgba(0,0,0,0)');
      g.addColorStop(1, 'rgba(0,0,0,0.5)');
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, W, H);
    }

    function animate() {
      time += 16;
      if (audio && !audio.paused && analyser) {
        beat = getBeat();
        smoothBeat += (beat - smoothBeat) * 0.15;
        beatFill.style.width = (smoothBeat * 100).toFixed(1) + '%';
      } else {
        smoothBeat += (0 - smoothBeat) * 0.05;
      }

      drawEvilSky();
      drawEvilGround();
      drawEvilBuildings();
      drawEvilCitadel();
      drawEvilFog();
      drawEvilVignette();

      requestAnimationFrame(animate);
    }

    soundBtn.addEventListener('click', () => {
      initAudio();
      if (audio.paused) {
        audio.play().catch(() => {});
        soundBtn.textContent = '⏸ Pause soundtrack';
      } else {
        audio.pause();
        soundBtn.textContent = '▶ Play main soundtrack';
      }
    });

    audio.addEventListener('play', () => { soundBtn.textContent = '⏸ Pause soundtrack'; });
    audio.addEventListener('pause', () => { soundBtn.textContent = '▶ Play main soundtrack'; });

    canvas.width = W;
    canvas.height = H;
    initAudio();
    animate();
  </script>
</body>
</html>
